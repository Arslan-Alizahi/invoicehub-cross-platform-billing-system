@page "/billing"
@inject IItemService ItemService
@inject ICategoryService CategoryService
@inject IBillService BillService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="container-fluid p-3">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex align-items-center mb-2">
                <div>
                    <h4 class="mb-0"><i class="fas fa-calculator"></i> New Bill</h4>
                    <small class="text-muted">Create professional bills and quotations</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Information -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-user"></i> Customer Information</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" @bind="customerName" placeholder="Enter customer name (mandatory)" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="number" class="form-control" @bind="customerPhone" placeholder="Enter phone number (optional)" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-control" @bind="customerAddress" placeholder="Enter address (optional)" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Selection -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-plus"></i> Add Items</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search items..." @bind="searchTerm" @onkeyup="SearchItems" />
                    </div>
                </div>
                <div class="col-md-3 mt-2 mt-md-0">
                    <select class="form-select" @bind="selectedCategoryId" @bind:after="FilterByCategory">
                        <option value="0">All Categories</option>
                        @foreach (var category in categories)
                        {
                            <option value="@category.Id">@category.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3 mt-2 mt-md-0">
                    <button class="btn btn-outline-primary w-100" @onclick="ToggleItemList">
                        <i class="fas fa-list"></i> @(showItemList ? "Hide" : "Show") Items
                    </button>
                </div>
            </div>

            @if (showItemList && filteredItems.Any())
            {
                <div class="mt-3" style="max-height: 300px; overflow-y: auto;">
                    <div class="row">
                        @foreach (var item in filteredItems)
                        {
                            <div class="col-12 col-md-6 mb-2">
                                <div class="card card-body p-2 @(item.StockQuantity == 0 ? "border-danger" : item.StockQuantity <= item.MinimumStockLevel ? "border-warning" : "")">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">@item.Name</h6>
                                            <small class="text-muted">@item.Company - ₨@item.Price.ToString("N0")</small>
                                            <br>
                                            @if (item.StockQuantity == 0)
                                            {
                                                <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Out of Stock</small>
                                            }
                                            else if (item.StockQuantity <= item.MinimumStockLevel)
                                            {
                                                <small class="text-warning"><i class="fas fa-exclamation-circle"></i> Low Stock (@item.StockQuantity left)</small>
                                            }
                                            else
                                            {
                                                <small class="text-success"><i class="fas fa-check-circle"></i> In Stock (@item.StockQuantity available)</small>
                                            }
                                        </div>
                                        <button class="btn btn-sm @(item.StockQuantity == 0 ? "btn-secondary" : "btn-primary")" 
                                                @onclick="async () => await AddItemToBill(item)" 
                                                disabled="@(item.StockQuantity == 0)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Bill Items -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-shopping-cart"></i> Bill Items</h6>
            @if (billItems.Any())
            {
                <button class="btn btn-sm btn-outline-danger" @onclick="ClearBill">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            }
        </div>
        <div class="card-body">
            @if (!billItems.Any())
            {
                <div class="text-center p-4">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h6>No items added</h6>
                    <p class="text-muted">Search and add items to create a bill</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Company</th>
                                <th>Unit Price</th>
                                <th>Qty</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var billItem in billItems)
                            {
                                <tr>
                                    <td>
                                        <div>
                                            <strong>@billItem.ItemName</strong>
                                            @if (!string.IsNullOrEmpty(billItem.ItemElectricalDetails))
                                            {
                                                <br><small class="text-muted">@billItem.ItemElectricalDetails</small>
                                            }
                                        </div>
                                    </td>
                                    <td>@billItem.ItemCompany</td>
                                    <td class="currency">₨@billItem.UnitPrice.ToString("N0")</td>
                                    <td>
                                        <div class="input-group input-group-sm" style="width: 100px;">
                                            <button class="btn btn-outline-secondary" @onclick="async () => await UpdateQuantity(billItem, billItem.Quantity - 1)">-</button>
                                            <input type="number" class="form-control text-center" @bind="billItem.Quantity" @bind:after="() => UpdateLineTotal(billItem)" min="1" />
                                            <button class="btn btn-outline-secondary" @onclick="async () => await UpdateQuantity(billItem, billItem.Quantity + 1)">+</button>
                                        </div>
                                    </td>
                                    <td class="currency">₨@billItem.LineTotal.ToString("N0")</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveItem(billItem)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Bill Summary -->
    @if (billItems.Any())
    {
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-calculator"></i> Bill Summary</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Discount (%)</label>
                            <input type="number" class="form-control" @bind="discountPercentage" @bind:after="CalculateTotals" min="0" max="100" step="0.1" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <input type="text" class="form-control" @bind="notes" placeholder="Add notes (optional)" />
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td class="text-end currency"><strong>₨@subTotal.ToString("N0")</strong></td>
                            </tr>
                            @if (discountPercentage > 0)
                            {
                                <tr>
                                    <td>Discount (@discountPercentage%):</td>
                                    <td class="text-end currency">₨@discountAmount.ToString("N0")</td>
                                </tr>
                            }
                            <tr class="table-success">
                                <td><strong>Total Amount:</strong></td>
                                <td class="text-end currency"><strong>₨@totalAmount.ToString("N0")</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

       

        <!-- Actions -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-secondary" @onclick="SaveAsQuotation" disabled="@isSaving">
                        @if (isSaving && savingAs == "quotation")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="fas fa-file-alt"></i> Save as Quotation
                    </button>
                    <button class="btn btn-warning" @onclick="SaveAsPending" disabled="@isSaving">
                        @if (isSaving && savingAs == "pending")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="fas fa-clock"></i> Mark as Pending
                    </button>
                    <button class="btn btn-success" @onclick="SaveAsPaid" disabled="@isSaving">
                        @if (isSaving && savingAs == "paid")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="fas fa-check"></i> Mark as Paid
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Footer -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="text-center">
                <small class="text-muted">
                    <i class="fas fa-code"></i> Built with <strong class="text-primary">CodingZoo</strong>
                </small>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Category> categories = new();
    private List<Item> allItems = new();
    private List<Item> filteredItems = new();
    private List<BillItemDto> billItems = new();
    private string searchTerm = string.Empty;
    private int selectedCategoryId = 0;
    private bool showItemList = false;
    private bool isSaving = false;
    private string savingAs = string.Empty;

    // Customer info
    private string customerName = string.Empty;
    private string customerPhone = string.Empty;
    private string customerAddress = string.Empty;

    // Bill calculations
    private decimal subTotal = 0;
    private decimal discountPercentage = 0;
    private decimal discountAmount = 0;
    private decimal totalAmount = 0;
    private string notes = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync();
            allItems = await ItemService.GetAllItemsAsync();
            filteredItems = allItems;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading data: {ex.Message}");
        }
    }

    private async Task SearchItems()
    {
        await Task.Delay(300); // Debounce
        ApplyFilters();
    }

    private void FilterByCategory()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredItems = allItems;

        if (selectedCategoryId > 0)
        {
            filteredItems = filteredItems.Where(i => i.CategoryId == selectedCategoryId).ToList();
        }

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredItems = filteredItems.Where(i =>
                i.Name.ToLower().Contains(term) ||
                i.Company.ToLower().Contains(term) ||
                i.Category.Name.ToLower().Contains(term) ||
                (i.ElectricalDetails != null && i.ElectricalDetails.ToLower().Contains(term))
            ).ToList();
        }
    }

    private void ToggleItemList()
    {
        showItemList = !showItemList;
    }

    private async Task AddItemToBill(Item item)
    {
        var existingItem = billItems.FirstOrDefault(bi => bi.ItemId == item.Id);
        var requestedQuantity = existingItem != null ? existingItem.Quantity + 1 : 1;
        
        // Check stock availability
        var hasStock = await ItemService.HasSufficientStockAsync(item.Id, requestedQuantity);
        if (!hasStock)
        {
            var availableStock = await ItemService.GetAvailableStockAsync(item.Id);
            if (availableStock == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Cannot add {item.Name} - Out of stock!");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Cannot add {item.Name} - Only {availableStock} units available in stock!");
            }
            return;
        }
        
        if (existingItem != null)
        {
            existingItem.Quantity++;
            UpdateLineTotal(existingItem);
        }
        else
        {
            var billItem = new BillItemDto
            {
                ItemId = item.Id,
                ItemName = item.Name,
                ItemCompany = item.Company,
                ItemCategory = item.Category.Name,
                ItemElectricalDetails = item.ElectricalDetails,
                UnitPrice = item.Price,
                Quantity = 1
            };
            UpdateLineTotal(billItem);
            billItems.Add(billItem);
        }
        CalculateTotals();
    }

    private async Task UpdateQuantity(BillItemDto billItem, int newQuantity)
    {
        if (newQuantity < 1) return;
        
        // Check stock availability when increasing quantity
        if (newQuantity > billItem.Quantity)
        {
            var hasStock = await ItemService.HasSufficientStockAsync(billItem.ItemId, newQuantity);
            if (!hasStock)
            {
                var availableStock = await ItemService.GetAvailableStockAsync(billItem.ItemId);
                if (availableStock == 0)
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"Cannot increase quantity for {billItem.ItemName} - Out of stock!");
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"Cannot increase quantity for {billItem.ItemName} - Only {availableStock} units available in stock!");
                }
                return;
            }
        }
        
        billItem.Quantity = newQuantity;
        UpdateLineTotal(billItem);
        CalculateTotals();
    }

    private void UpdateLineTotal(BillItemDto billItem)
    {
        billItem.LineTotal = billItem.UnitPrice * billItem.Quantity;
    }

    private void RemoveItem(BillItemDto billItem)
    {
        billItems.Remove(billItem);
        CalculateTotals();
    }

    private void ClearBill()
    {
        billItems.Clear();
        CalculateTotals();
    }

    private void CalculateTotals()
    {
        subTotal = billItems.Sum(bi => bi.LineTotal);
        discountAmount = subTotal * (discountPercentage / 100);
        totalAmount = subTotal - discountAmount;
    }

    private async Task SaveAsQuotation()
    {
        await SaveBill(BillStatus.Quotation, "quotation");
    }

    private async Task SaveAsPending()
    {
        await SaveBill(BillStatus.PaymentPending, "pending");
    }

    private async Task SaveAsPaid()
    {
        await SaveBill(BillStatus.Paid, "paid");
    }

    private async Task SaveBill(BillStatus status, string savingType)
    {
        if (!billItems.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please add at least one item to the bill.");
            return;
        }

        isSaving = true;
        savingAs = savingType;

        try
        {
            var bill = new Bill
            {
                CustomerName = string.IsNullOrWhiteSpace(customerName) ? null : customerName,
                CustomerPhone = string.IsNullOrWhiteSpace(customerPhone) ? null : customerPhone,
                CustomerAddress = string.IsNullOrWhiteSpace(customerAddress) ? null : customerAddress,
                SubTotal = subTotal,
                DiscountPercentage = discountPercentage,
                DiscountAmount = discountAmount,
                TotalAmount = totalAmount,
                Status = status,
                Notes = string.IsNullOrWhiteSpace(notes) ? null : notes,
                BillItems = billItems.Select(bi => new BillItem
                {
                    ItemId = bi.ItemId,
                    ItemName = bi.ItemName,
                    ItemCompany = bi.ItemCompany,
                    ItemCategory = bi.ItemCategory,
                    ItemElectricalDetails = bi.ItemElectricalDetails,
                    UnitPrice = bi.UnitPrice,
                    Quantity = bi.Quantity,
                    LineTotal = bi.LineTotal
                }).ToList()
            };

            var savedBill = await BillService.CreateBillAsync(bill);
            
            // Reduce stock for paid bills
            if (status == BillStatus.Paid)
            {
                foreach (var billItem in billItems)
                {
                    try
                    {
                        await ItemService.ReduceStockAsync(billItem.ItemId, billItem.Quantity);
                    }
                    catch (Exception stockEx)
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"Warning: Could not reduce stock for {billItem.ItemName}: {stockEx.Message}");
                    }
                }
            }
            
            await JSRuntime.InvokeVoidAsync("alert", $"Bill {savedBill.BillNumber} saved successfully!");
            Navigation.NavigateTo($"/bills/{savedBill.Id}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving bill: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            savingAs = string.Empty;
        }
    }

    public class BillItemDto
    {
        public int ItemId { get; set; }
        public string ItemName { get; set; } = string.Empty;
        public string ItemCompany { get; set; } = string.Empty;
        public string? ItemCategory { get; set; }
        public string? ItemElectricalDetails { get; set; }
        public decimal UnitPrice { get; set; }
        public int Quantity { get; set; }
        public decimal LineTotal { get; set; }
    }
}
