@page "/items"
@inject IItemService ItemService
@inject ICategoryService CategoryService
@inject IJSRuntime JSRuntime

<div class="container-fluid p-3">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-box"></i> Products</h4>
                    <small class="text-muted">Manage your inventory products</small>
                </div>
                <button class="btn btn-primary" @onclick="ShowAddModal">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-3">
        <div class="col-12 col-md-8">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Search items..." @bind="searchTerm" @onkeyup="SearchItems" />
            </div>
        </div>
        <div class="col-12 col-md-4 mt-2 mt-md-0">
            <select class="form-select" @bind="selectedCategoryId" @bind:after="FilterByCategory">
                <option value="0">All Categories</option>
                @foreach (var category in categories)
                {
                    <option value="@category.Id">@category.Name</option>
                }
            </select>
        </div>
    </div>

    <!-- Items List -->
    @if (isLoading)
    {
        <div class="text-center p-4">
            <div class="spinner"></div>
            <p class="mt-2">Loading items...</p>
        </div>
    }
    else if (!filteredItems.Any())
    {
        <div class="card">
            <div class="card-body text-center p-5">
                <i class="fas fa-box fa-3x text-muted mb-3"></i>
                <h5>No Items Found</h5>
                <p class="text-muted">
                    @if (string.IsNullOrEmpty(searchTerm) && selectedCategoryId == 0)
                    {
                        <text>Start by adding your first item</text>
                    }
                    else
                    {
                        <text>Try adjusting your search or filter criteria</text>
                    }
                </p>
                @if (string.IsNullOrEmpty(searchTerm) && selectedCategoryId == 0)
                {
                    <button class="btn btn-primary" @onclick="ShowAddModal">
                        <i class="fas fa-plus"></i> Add First Item
                    </button>
                }
            </div>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var item in filteredItems)
            {
                <div class="col-12 col-md-6 col-lg-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">@item.Name</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><button class="dropdown-item" type="button" @onclick="() => ShowEditModal(item)">
                                            <i class="fas fa-edit"></i> Edit
                                        </button></li>
                                        <li><button class="dropdown-item text-danger" type="button" @onclick="() => DeleteItem(item)">
                                            <i class="fas fa-trash"></i> Delete
                                        </button></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="badge bg-info">@item.Category.Name</span>
                                <span class="currency ms-2">₨@item.Price.ToString("N0")</span>
                            </div>
                            <div class="mb-2">
                                <span class="badge @(item.StockQuantity <= item.MinimumStockLevel ? "bg-danger" : "bg-success")">
                                    <i class="fas fa-boxes"></i> Stock: @item.StockQuantity
                                </span>
                                @if (item.StockQuantity <= item.MinimumStockLevel)
                                {
                                    <span class="badge bg-warning text-dark ms-1">
                                        <i class="fas fa-exclamation-triangle"></i> Low Stock
                                    </span>
                                }
                            </div>
                            <p class="card-text small text-muted mb-1">
                                <i class="fas fa-building"></i> @item.Company
                            </p>
                            @if (!string.IsNullOrEmpty(item.PowerRating))
                            {
                                <p class="card-text small text-muted mb-1">
                                    <i class="fas fa-bolt"></i> @item.PowerRating
                                </p>
                            }
                            @if (!string.IsNullOrEmpty(item.ElectricalDetails))
                            {
                                <p class="card-text small text-muted">
                                    @item.ElectricalDetails
                                </p>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Add/Edit Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @if (editingItem == null)
                        {
                            <i class="fas fa-plus"></i> <text>Add Item</text>
                        }
                        else
                        {
                            <i class="fas fa-edit"></i> <text>Edit Item</text>
                        }
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideModal"></button>
                </div>
                <EditForm Model="itemForm" OnValidSubmit="SaveItem">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Name *</label>
                                    <InputText class="form-control" @bind-Value="itemForm.Name" placeholder="Enter item name" />
                                    <ValidationMessage For="@(() => itemForm.Name)" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Category *</label>
                                    <InputSelect class="form-select" @bind-Value="itemForm.CategoryId">
                                        <option value="0">Select Category</option>
                                        @foreach (var category in categories)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => itemForm.CategoryId)" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Price (₨) *</label>
                                    <InputNumber class="form-control" @bind-Value="itemForm.Price" placeholder="0" />
                                    <ValidationMessage For="@(() => itemForm.Price)" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company *</label>
                                    <InputText class="form-control" @bind-Value="itemForm.Company" placeholder="Enter company name" />
                                    <ValidationMessage For="@(() => itemForm.Company)" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Power Rating</label>
                                    <InputText class="form-control" @bind-Value="itemForm.PowerRating" placeholder="e.g., 9W, 2.5mm²" />
                                    <ValidationMessage For="@(() => itemForm.PowerRating)" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <InputText class="form-control" @bind-Value="itemForm.Type" placeholder="e.g., LED, Copper" />
                                    <ValidationMessage For="@(() => itemForm.Type)" />
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Electrical Details</label>
                            <InputTextArea class="form-control" @bind-Value="itemForm.ElectricalDetails" rows="2" placeholder="Enter electrical specifications" />
                            <ValidationMessage For="@(() => itemForm.ElectricalDetails)" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea class="form-control" @bind-Value="itemForm.Description" rows="3" placeholder="Enter item description (optional)" />
                            <ValidationMessage For="@(() => itemForm.Description)" />
                        </div>
                        
                        <!-- Stock Management Section -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fas fa-boxes"></i> Stock Management</h6>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stock Quantity *</label>
                                    <InputNumber class="form-control" @bind-Value="itemForm.StockQuantity" placeholder="0" />
                                    <ValidationMessage For="@(() => itemForm.StockQuantity)" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Minimum Stock Level *</label>
                                    <InputNumber class="form-control" @bind-Value="itemForm.MinimumStockLevel" placeholder="0" />
                                    <ValidationMessage For="@(() => itemForm.MinimumStockLevel)" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Maximum Stock Level</label>
                                    <InputNumber class="form-control" @bind-Value="itemForm.MaximumStockLevel" placeholder="0" />
                                    <ValidationMessage For="@(() => itemForm.MaximumStockLevel)" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="HideModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            @if (editingItem == null)
                            {
                                <text>Add Item</text>
                            }
                            else
                            {
                                <text>Update Item</text>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

    <!-- Footer -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="text-center">
                <small class="text-muted">
                    <i class="fas fa-code"></i> Built with <strong class="text-primary">CodingZoo</strong>
                </small>
            </div>
        </div>
    </div>

@code {
    private List<Item> items = new();
    private List<Item> filteredItems = new();
    private List<Category> categories = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isSaving = false;
    private Item? editingItem = null;
    private ItemForm itemForm = new();
    private string searchTerm = string.Empty;
    private int selectedCategoryId = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync();
            items = await ItemService.GetAllItemsAsync();
            filteredItems = items;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await Task.Delay(100);
            await JSRuntime.InvokeVoidAsync("initializeDropdowns");
        }
    }

    private async Task SearchItems()
    {
        await Task.Delay(300); // Debounce
        ApplyFilters();
    }

    private void FilterByCategory()
    {
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredItems = items;

        if (selectedCategoryId > 0)
        {
            filteredItems = filteredItems.Where(i => i.CategoryId == selectedCategoryId).ToList();
        }

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower();
            filteredItems = filteredItems.Where(i =>
                i.Name.ToLower().Contains(term) ||
                i.Company.ToLower().Contains(term) ||
                i.Category.Name.ToLower().Contains(term) ||
                (i.ElectricalDetails != null && i.ElectricalDetails.ToLower().Contains(term))
            ).ToList();
        }
    }

    private void ShowAddModal()
    {
        editingItem = null;
        itemForm = new ItemForm();
        showModal = true;
    }

    private void ShowEditModal(Item item)
    {
        editingItem = item;
        itemForm = new ItemForm
        {
            Name = item.Name,
            CategoryId = item.CategoryId,
            Price = item.Price,
            Company = item.Company,
            PowerRating = item.PowerRating,
            Type = item.Type,
            ElectricalDetails = item.ElectricalDetails,
            Description = item.Description,
            StockQuantity = item.StockQuantity,
            MinimumStockLevel = item.MinimumStockLevel,
            MaximumStockLevel = item.MaximumStockLevel ?? 0
        };
        showModal = true;
    }

    private void HideModal()
    {
        showModal = false;
        editingItem = null;
        itemForm = new ItemForm();
    }

    private async Task SaveItem()
    {
        isSaving = true;
        try
        {
            if (editingItem == null)
            {
                // Add new item
                var newItem = new Item
                {
                    Name = itemForm.Name,
                    CategoryId = itemForm.CategoryId,
                    Price = itemForm.Price,
                    Company = itemForm.Company,
                    PowerRating = itemForm.PowerRating,
                    Type = itemForm.Type,
                    ElectricalDetails = itemForm.ElectricalDetails,
                    Description = itemForm.Description,
                    StockQuantity = itemForm.StockQuantity,
                    MinimumStockLevel = itemForm.MinimumStockLevel,
                    MaximumStockLevel = itemForm.MaximumStockLevel == 0 ? (int?)null : itemForm.MaximumStockLevel
                };
                await ItemService.CreateItemAsync(newItem);
            }
            else
            {
                // Update existing item
                editingItem.Name = itemForm.Name;
                editingItem.CategoryId = itemForm.CategoryId;
                editingItem.Price = itemForm.Price;
                editingItem.Company = itemForm.Company;
                editingItem.PowerRating = itemForm.PowerRating;
                editingItem.Type = itemForm.Type;
                editingItem.ElectricalDetails = itemForm.ElectricalDetails;
                editingItem.Description = itemForm.Description;
                editingItem.StockQuantity = itemForm.StockQuantity;
                editingItem.MinimumStockLevel = itemForm.MinimumStockLevel;
                editingItem.MaximumStockLevel = itemForm.MaximumStockLevel == 0 ? (int?)null : itemForm.MaximumStockLevel;
                await ItemService.UpdateItemAsync(editingItem);
            }

            await LoadData();
            HideModal();
            await Task.Delay(100);
            await JSRuntime.InvokeVoidAsync("initializeDropdowns");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving item: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteItem(Item item)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to delete '{item.Name}'? This action cannot be undone.");

        if (!confirmed) return;

        try
        {
            var deleted = await ItemService.DeleteItemAsync(item.Id);
            if (deleted)
            {
                await LoadData();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert",
                    "Cannot delete this item because it's used in bills.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error deleting item: {ex.Message}");
        }
    }

    public class ItemForm
    {
        [Required(ErrorMessage = "Item name is required")]
        [StringLength(200, ErrorMessage = "Item name cannot exceed 200 characters")]
        public string Name { get; set; } = string.Empty;

        [Range(1, int.MaxValue, ErrorMessage = "Please select a category")]
        public int CategoryId { get; set; }

        [Required(ErrorMessage = "Price is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Price must be greater than 0")]
        public decimal Price { get; set; }

        [Required(ErrorMessage = "Company is required")]
        [StringLength(100, ErrorMessage = "Company name cannot exceed 100 characters")]
        public string Company { get; set; } = string.Empty;

        [StringLength(100, ErrorMessage = "Power rating cannot exceed 100 characters")]
        public string? PowerRating { get; set; }

        [StringLength(100, ErrorMessage = "Type cannot exceed 100 characters")]
        public string? Type { get; set; }

        [StringLength(500, ErrorMessage = "Electrical details cannot exceed 500 characters")]
        public string? ElectricalDetails { get; set; }

        [StringLength(1000, ErrorMessage = "Description cannot exceed 1000 characters")]
        public string? Description { get; set; }

        [Required(ErrorMessage = "Stock quantity is required")]
        [Range(0, int.MaxValue, ErrorMessage = "Stock quantity must be 0 or greater")]
        public int StockQuantity { get; set; }

        [Required(ErrorMessage = "Minimum stock level is required")]
        [Range(0, int.MaxValue, ErrorMessage = "Minimum stock level must be 0 or greater")]
        public int MinimumStockLevel { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "Maximum stock level must be 0 or greater")]
        public int MaximumStockLevel { get; set; }
    }
}
